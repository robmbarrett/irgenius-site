<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Friendzap - Nostr Client</title>
  <script src="https://unpkg.com/nostr-tools@2.19.4/lib/nostr.bundle.js"></script>
  <style>
    /* Keep all previous styles, add these for login */
    #login-screen {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      flex-direction: column;
      text-align: center;
      padding: 20px;
    }
    #login-screen.hidden {
      display: none;
    }
    #main-content.hidden {
      display: none;
    }
    .login-btn {
      padding: 16px 32px;
      font-size: 20px;
      background: #0066cc;
      border: none;
      color: white;
      border-radius: 8px;
      cursor: pointer;
      margin: 20px 0;
    }
    .login-btn:hover {
      background: #0055aa;
    }
    #user-info {
      font-size: 16px;
      color: #4caf50;
      margin: 10px 0;
    }
    .note { /* existing */ }
    /* ... rest of styles unchanged ... */
  </style>
  <script>
    let relayPool = null;
    let sub = null;
    let userPubkey = null; // Will store hex pubkey after login

    async function fetchBitcoinPrice() {
      // unchanged
      try {
        const res = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=usd');
        const data = await res.json();
        const price = data.bitcoin.usd;
        document.getElementById('btc-price').textContent = `$${price.toLocaleString('en-US', {minimumFractionDigits: 0})}`;
      } catch (err) {
        document.getElementById('btc-price').textContent = 'Error';
      }
    }

    function set200WMA() {
      const wmaValue = 57849;
      document.getElementById('btc-200wma').textContent = `~$${wmaValue.toLocaleString('en-US', {minimumFractionDigits: 0})}`;
    }

    function getRelays() {
      const r1 = document.getElementById('relay1')?.value.trim() || 'wss://relay.damus.io';
      const r2 = document.getElementById('relay2')?.value.trim();
      const relays = [r1];
      if (r2) relays.push(r2);
      return relays;
    }

    async function connectAndSubscribe() {
      const relays = getRelays();
      console.log('Connecting to:', relays);

      if (relayPool) relayPool.close();
      if (sub) sub.unsub();

      relayPool = new window.nostrTools.RelayPool(relays);

      relayPool.on('open', relay => console.log('Connected:', relay.url));
      relayPool.on('error', (_, err) => console.error('Relay error:', err));

      relayPool.connect();

      const since = Math.floor(Date.now() / 1000) - 86400 * 2; // 48h for more notes
      sub = relayPool.sub([{ kinds: [1], since }]);

      sub.on('event', event => renderNote(event));

      document.getElementById('feed').innerHTML = '<p style="color:#666; text-align:center;">Fetching notes...</p>';
    }

    function renderNote(event) {
      const feed = document.getElementById('feed');
      const short = event.pubkey.slice(0,8) + '...' + event.pubkey.slice(-8);
      const time = new Date(event.created_at * 1000).toLocaleString([], {hour:'2-digit', minute:'2-digit', month:'short', day:'numeric'});

      const div = document.createElement('div');
      div.className = 'note';
      div.innerHTML = `
        <div class="pubkey">From: ${short}</div>
        <div class="content">${escapeHtml(event.content)}</div>
        <div class="time">${time}</div>
      `;
      feed.insertBefore(div, feed.firstChild);
    }

    function escapeHtml(unsafe) {
      return unsafe.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#039;'})[m]);
    }

    async function tryLogin() {
      if (!window.nostr) {
        alert('No NIP-07 extension detected! Install one like Nos2x or Alby, then reload.');
        return;
      }

      try {
        userPubkey = await window.nostr.getPublicKey();
        const short = userPubkey.slice(0,8) + '...' + userPubkey.slice(-8);
        document.getElementById('user-info').textContent = `Logged in as npub1${short}`;
        document.getElementById('header').textContent = `Friendzap - @npub1${short}`;
        document.getElementById('login-screen').classList.add('hidden');
        document.getElementById('main-content').classList.remove('hidden');
        connectAndSubscribe(); // Start feed after login
      } catch (err) {
        alert('Login failed or denied: ' + err.message);
      }
    }

    function logout() {
      userPubkey = null;
      document.getElementById('user-info').textContent = '';
      document.getElementById('header').textContent = 'Friendzap (Anonymous)';
      document.getElementById('login-screen').classList.remove('hidden');
      document.getElementById('main-content').classList.add('hidden');
      if (relayPool) relayPool.close();
    }

    window.onload = () => {
      fetchBitcoinPrice();
      set200WMA();
      setInterval(fetchBitcoinPrice, 60000);

      // Auto-try extension if present, but show login screen anyway
      if (window.nostr) {
        // Could auto-login here, but better to let user click
      }

      document.getElementById('login-screen').classList.remove('hidden');
      document.getElementById('main-content').classList.add('hidden');
    };
  </script>
</head>
<body>

  <!-- Login Overlay -->
  <div id="login-screen">
    <h1>Welcome to Friendzap</h1>
    <p>Connect your Nostr identity securely via browser extension (NIP-07).<br>No private keys are shared with the site.</p>
    <button class="login-btn" onclick="tryLogin()">Connect with Nostr Extension</button>
    <p style="font-size:14px; color:#aaa; margin-top:20px;">
      (Install Nos2x, Alby, or similar from your browser store if not already set up)
    </p>
  </div>

  <div id="main-content" class="hidden">
    <div id="header">Friendzap</div>

    <div class="container">
      <!-- Left Pane -->
      <div class="pane left-pane">
        <div id="user-info"></div>
        <div class="nav-item active" onclick="showSection('home')">Home</div>
        <div class="nav-item" onclick="showSection('settings')">Settings</div>

        <div id="home" class="section active">
          <p style="color:#888;">Your feed is loading...</p>
          <button onclick="connectAndSubscribe()" style="margin:10px auto; display:block;">Refresh Feed</button>
        </div>

        <div id="settings" class="section">
          <h3>Network Settings</h3>
          <div class="settings-form">
            <label>Relay 1:</label>
            <input type="text" id="relay1" value="wss://relay.damus.io" />
            <label>Relay 2 (optional):</label>
            <input type="text" id="relay2" value="" />
            <button onclick="connectAndSubscribe()">Save & Refresh Feed</button>

            <button onclick="logout()" style="margin-top:30px; background:#cc0000;">Disconnect / Logout</button>

            <!-- Quick Next Steps unchanged or updated -->
            <div class="quick-steps">
              <h4>Next Steps</h4>
              <ol>
                <li>Personalized feed: Use kind:3 to get follows, then filter notes from followed pubkeys.</li>
                <li>Add posting: Form + window.nostr.signEvent() for kind:1.</li>
                <li>Zaps via NWC (paste URI, limited budget).</li>
                <li>Persist pubkey/relays in localStorage.</li>
              </ol>
            </div>
          </div>
        </div>
      </div>

      <!-- Center Feed -->
      <div class="pane center-pane" id="feed">
        <p style="color:#666; text-align:center; margin-top:100px;">Feed will load after connection...</p>
      </div>

      <!-- Right BTC -->
      <div class="pane right-pane">
        <div class="price-box">
          <h2>Bitcoin Price</h2>
          <div id="btc-price" class="price">Loading...</div>
        </div>
        <div class="price-box">
          <h2>Bitcoin 200-Week MA</h2>
          <div id="btc-200wma" class="price">Loading...</div>
        </div>
      </div>
    </div>
  </div>

</body>
</html>
