<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Friendzap - Nostr Client</title>
  <!-- Updated CDN: jsDelivr +esm for latest nostr-tools (2026 compatible) -->
  <script type="module">
    import * as nostrTools from 'https://cdn.jsdelivr.net/npm/nostr-tools@2.21.0/+esm';
    window.nostrTools = nostrTools;  // Expose globally so non-module code can use it
  </script>
  <style>
    /* Previous styles unchanged – add if missing from your copy */
    body { margin:0; font-family:sans-serif; background:#0f0f0f; color:#e0e0e0; height:100vh; overflow:hidden; }
    #header { background:#1a1a1a; padding:12px; text-align:center; font-size:28px; font-weight:bold; border-bottom:1px solid #333; }
    .container { display:flex; height:calc(100vh - 60px); }
    .pane { border-right:1px solid #333; overflow-y:auto; padding:20px; }
    .left-pane { width:280px; background:#111; }
    .center-pane { flex:1; background:#0a0a0a; }
    .right-pane { width:320px; background:#111; }
    .nav-item { padding:14px 20px; cursor:pointer; font-size:18px; border-bottom:1px solid #222; }
    .nav-item:hover, .nav-item.active { background:#222; }
    .section { display:none; }
    .section.active { display:block; }
    .note { background:#1e1e1e; padding:12px; margin:12px 0; border-radius:8px; border:1px solid #333; }
    .note .pubkey { color:#888; font-size:14px; margin-bottom:6px; }
    .note .content { white-space:pre-wrap; word-break:break-word; }
    .note .time { color:#666; font-size:12px; margin-top:8px; }
    #login-screen { position:fixed; inset:0; background:rgba(0,0,0,0.9); display:flex; flex-direction:column; align-items:center; justify-content:center; z-index:1000; text-align:center; padding:20px; }
    #login-screen.hidden { display:none; }
    #main-content.hidden { display:none; }
    .login-btn { padding:16px 32px; font-size:20px; background:#0066cc; border:none; color:white; border-radius:8px; cursor:pointer; margin:20px 0; }
    .login-btn:hover { background:#0055aa; }
    #user-info { font-size:16px; color:#4caf50; margin:10px 0; }
    button.retry { margin:20px auto; display:block; padding:12px 24px; background:#0066cc; color:white; border:none; border-radius:6px; cursor:pointer; }
  </style>
  <script>
    let relayPool = null;
    let sub = null;
    let userPubkey = null;

    async function fetchBitcoinPrice() {
      try {
        const res = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=usd');
        const data = await res.json();
        document.getElementById('btc-price').textContent = `$${data.bitcoin.usd.toLocaleString('en-US', {minimumFractionDigits: 0})}`;
      } catch {}
    }

    function set200WMA() {
      document.getElementById('btc-200wma').textContent = '~$57849';
    }

    function getRelays() {
      return [
        document.getElementById('relay1')?.value.trim() || 'wss://relay.damus.io',
        document.getElementById('relay2')?.value.trim() || ''
      ].filter(Boolean);
    }

    function connectAndSubscribe() {
      const relays = getRelays();
      console.log('Trying relays:', relays);

      if (relayPool) relayPool.close();
      if (sub) sub.unsub();

      try {
        relayPool = new window.nostrTools.RelayPool(relays);
      } catch (e) {
        console.error('RelayPool failed:', e);
        document.getElementById('feed').innerHTML = '<p style="color:red; text-align:center;">Error initializing Nostr (check console)</p>';
        return;
      }

      relayPool.on('open', r => console.log('Open:', r.url));
      relayPool.on('error', (_, e) => console.error('Relay err:', e));

      relayPool.connect();

      const since = Math.floor(Date.now() / 1000) - 86400 * 7; // 7 days for more content
      sub = relayPool.sub([{ kinds: [1], since }]);

      sub.on('event', e => {
        console.log('Event received');
        renderNote(e);
      });

      document.getElementById('feed').innerHTML = '<p style="color:#4caf50; text-align:center;">Connected – fetching notes...</p>';
    }

    function renderNote(event) {
      const feed = document.getElementById('feed');
      const short = event.pubkey.slice(0,8) + '…' + event.pubkey.slice(-8);
      const time = new Date(event.created_at * 1000).toLocaleString([], {hour:'2-digit', minute:'2-digit', month:'short', day:'numeric'});

      const div = document.createElement('div');
      div.className = 'note';
      div.innerHTML = `<div class="pubkey">npub1${short}</div><div class="content">${escapeHtml(event.content)}</div><div class="time">${time}</div>`;
      feed.insertBefore(div, feed.firstChild);
    }

    function escapeHtml(s) {
      return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#039;'})[c]);
    }

    async function tryLogin() {
      if (!window.nostr) {
        alert('No NIP-07 extension found. Install Alby/Nos2x/etc. and reload.');
        return;
      }
      try {
        userPubkey = await window.nostr.getPublicKey();
        const short = userPubkey.slice(0,8) + '…' + userPubkey.slice(-8);
        document.getElementById('user-info').textContent = `Logged in as npub1${short}`;
        document.getElementById('header').textContent = `Friendzap - npub1${short}`;
        document.getElementById('login-screen').classList.add('hidden');
        document.getElementById('main-content').classList.remove('hidden');
        connectAndSubscribe();
      } catch (err) {
        alert('Connection denied or failed: ' + err.message);
      }
    }

    function logout() {
      userPubkey = null;
      document.getElementById('user-info').textContent = '';
      document.getElementById('header').textContent = 'Friendzap';
      document.getElementById('login-screen').classList.remove('hidden');
      document.getElementById('main-content').classList.add('hidden');
      if (relayPool) relayPool.close();
    }

    window.addEventListener('load', () => {
      fetchBitcoinPrice();
      set200WMA();
      setInterval(fetchBitcoinPrice, 60000);
      document.getElementById('login-screen').classList.remove('hidden');
      document.getElementById('main-content').classList.add('hidden');
    });
  </script>
</head>
<body>

  <div id="login-screen">
    <h1>Friendzap</h1>
    <p>Connect securely with your Nostr extension (Alby, Nos2x, etc.)</p>
    <button class="login-btn" onclick="tryLogin()">Connect with Nostr Extension</button>
    <p style="font-size:14px; color:#aaa;">If loading is slow, wait or refresh after extension is ready.</p>
  </div>

  <div id="main-content" class="hidden">
    <div id="header">Friendzap</div>
    <div class="container">
      <div class="pane left-pane">
        <div id="user-info"></div>
        <div class="nav-item active" onclick="document.querySelector('#home').classList.add('active'); document.querySelector('#settings').classList.remove('active');">Home</div>
        <div class="nav-item" onclick="document.querySelector('#settings').classList.add('active'); document.querySelector('#home').classList.remove('active');">Settings</div>

        <div id="home" class="section active">
          <p style="color:#888;">Feed loading...</p>
          <button class="retry" onclick="connectAndSubscribe()">Retry / Refresh Feed</button>
        </div>

        <div id="settings" class="section">
          <h3>Network Settings</h3>
          <label>Relay 1:</label><input type="text" id="relay1" value="wss://relay.damus.io" style="width:100%; padding:8px; margin:8px 0; background:#222; color:white; border:1px solid #444;"/>
          <label>Relay 2 (optional):</label><input type="text" id="relay2" value="wss://nos.lol" style="width:100%; padding:8px; margin:8px 0; background:#222; color:white; border:1px solid #444;"/>
          <button onclick="connectAndSubscribe()" style="padding:10px 20px; background:#0066cc; color:white; border:none; border-radius:4px; cursor:pointer;">Save & Refresh</button>
          <button onclick="logout()" style="margin-top:20px; padding:10px 20px; background:#cc0000; color:white; border:none; border-radius:4px; cursor:pointer;">Disconnect</button>
        </div>
      </div>

      <div class="pane center-pane" id="feed">
        <p style="color:#666; text-align:center; margin-top:100px;">Feed will load after connection...</p>
      </div>

      <div class="pane right-pane">
        <div style="background:#1e1e1e; padding:20px; margin-bottom:20px; border-radius:8px; text-align:center;">
          <h2>Bitcoin Price</h2>
          <div id="btc-price" style="font-size:32px; font-weight:bold; color:#f7931a;">Loading...</div>
        </div>
        <div style="background:#1e1e1e; padding:20px; border-radius:8px; text-align:center;">
          <h2>Bitcoin 200-Week MA</h2>
          <div id="btc-200wma" style="font-size:32px; font-weight:bold; color:#f7931a;">Loading...</div>
        </div>
      </div>
    </div>
  </div>

</body>
</html>
