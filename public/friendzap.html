<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Friendzap - Nostr Client</title>
  <style>
    body { margin:0; font-family:sans-serif; background:#0f0f0f; color:#e0e0e0; height:100vh; overflow:hidden; }
    #header { background:#1a1a1a; padding:12px; text-align:center; font-size:28px; font-weight:bold; border-bottom:1px solid #333; }
    .container { display:flex; height:calc(100vh - 60px); }
    .pane { border-right:1px solid #333; overflow-y:auto; padding:20px; }
    .left-pane { width:280px; background:#111; }
    .center-pane { flex:1; background:#0a0a0a; }
    .right-pane { width:320px; background:#111; }
    .nav-item { padding:14px 20px; cursor:pointer; font-size:18px; border-bottom:1px solid #222; }
    .nav-item:hover, .nav-item.active { background:#222; }
    .section { display:none; }
    .section.active { display:block; }
    .note { background:#1e1e1e; padding:12px; margin:12px 0; border-radius:8px; border:1px solid #333; }
    .note .pubkey { color:#888; font-size:14px; margin-bottom:6px; }
    .note .content { white-space:pre-wrap; word-break:break-word; }
    .note .time { color:#666; font-size:12px; margin-top:8px; }
    #login-screen { position:fixed; inset:0; background:rgba(0,0,0,0.9); display:flex; flex-direction:column; align-items:center; justify-content:center; z-index:1000; text-align:center; padding:20px; }
    #login-screen.hidden { display:none; }
    #main-content.hidden { display:none; }
    .login-btn, .anon-btn { padding:12px 24px; font-size:18px; margin:10px; border:none; border-radius:6px; cursor:pointer; }
    .login-btn { background:#0066cc; color:white; }
    .anon-btn { background:#444; color:white; }
    #user-info { font-size:16px; color:#4caf50; margin:10px 0; }
    button.retry { margin:20px auto; display:block; padding:12px 24px; background:#0066cc; color:white; border:none; border-radius:6px; cursor:pointer; }
    input[type="text"] { width:100%; padding:8px; margin:8px 0; background:#222; color:white; border:1px solid #444; }
    #follows-info { margin-top:20px; font-size:14px; color:#aaa; }
  </style>
  <script>
    let ws = null;
    let userPubkey = null;
    let subscriptionId = null;
    let contactsSubId = null;
    let followsCount = 0;

    async function fetchBitcoinPrice() {
      try {
        const res = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=usd');
        const data = await res.json();
        document.getElementById('btc-price').textContent = `$${data.bitcoin.usd.toLocaleString('en-US', {minimumFractionDigits: 0})}`;
      } catch {}
    }

    function set200WMA() {
      document.getElementById('btc-200wma').textContent = '~$57849';
    }

    function loadSavedRelay() {
      const saved = localStorage.getItem('friendzap-relay');
      if (saved) {
        document.getElementById('relay').value = saved;
      }
    }

    function saveRelay() {
      const url = document.getElementById('relay').value.trim();
      if (url && url.startsWith('wss://')) {
        localStorage.setItem('friendzap-relay', url);
        console.log('Relay saved:', url);
      }
    }

    function getRelayUrl() {
      let url = document.getElementById('relay').value.trim();
      if (!url || !url.startsWith('wss://')) {
        url = 'wss://relay.damus.io';
      }
      console.log('Using relay:', url);
      return url;
    }

    function connectAndSubscribe() {
      saveRelay();

      const url = getRelayUrl();

      if (ws) {
        ws.close();
      }

      ws = new WebSocket(url);

      ws.onopen = () => {
        console.log('WebSocket open to', url);
        document.getElementById('feed').innerHTML = '<p style="color:#4caf50; text-align:center;">Connected – requesting notes...</p>';

        subscriptionId = 'notes-' + Math.random().toString(36).substring(2, 12);

        const since = Math.floor(Date.now() / 1000) - 86400 * 30;
        const notesReq = [
          "REQ",
          subscriptionId,
          { kinds: [1], since, limit: 50 }
        ];
        ws.send(JSON.stringify(notesReq));
        console.log('Sent notes REQ');

        if (userPubkey) {
          contactsSubId = 'contacts-' + Math.random().toString(36).substring(2, 12);
          const contactsReq = [
            "REQ",
            contactsSubId,
            { kinds: [3], authors: [userPubkey], limit: 1 }
          ];
          ws.send(JSON.stringify(contactsReq));
          console.log('Sent contacts REQ for pubkey', userPubkey);
          document.getElementById('follows-info').textContent = 'Loading your follows...';
        }
      };

      ws.onmessage = (msgEvent) => {
        const msg = JSON.parse(msgEvent.data);
        console.log('Received:', msg);

        if (msg[0] === 'EVENT') {
          const event = msg[2];
          if (event.kind === 1) {
            renderNote(event);
          } else if (event.kind === 3 && event.pubkey === userPubkey) {
            try {
              const followedPubkeys = event.tags
                .filter(tag => tag[0] === 'p')
                .map(tag => tag[1]);
              followsCount = followedPubkeys.length;
              document.getElementById('follows-info').textContent = `You follow ${followsCount} people`;
              console.log('Follows count loaded:', followsCount);
            } catch (e) {
              console.error('Error parsing kind 3:', e);
              document.getElementById('follows-info').textContent = 'Error loading follows';
            }
          }
        } else if (msg[0] === 'EOSE' && msg[1] === subscriptionId) {
          console.log('EOSE for notes');
          if (document.querySelectorAll('.note').length === 0) {
            document.getElementById('feed').innerHTML += '<p style="color:#ff9800; text-align:center;">No recent notes on this relay</p>';
          }
        } else if (msg[0] === 'EOSE' && msg[1] === contactsSubId) {
          console.log('EOSE for contacts');
          if (followsCount === 0) {
            document.getElementById('follows-info').textContent = 'No follows found on this relay';
          }
        } else if (msg[0] === 'NOTICE') {
          console.warn('Relay notice:', msg[1]);
        }
      };

      ws.onerror = (err) => {
        console.error('WS error:', err);
        document.getElementById('feed').innerHTML = '<p style="color:red;">Connection error – check relay URL</p>';
      };

      ws.onclose = () => {
        console.log('WS closed');
      };
    }

    function renderNote(event) {
      const feed = document.getElementById('feed');
      const short = event.pubkey.slice(0,8) + '…' + event.pubkey.slice(-8);
      const time = new Date(event.created_at * 1000).toLocaleString([], {hour:'2-digit', minute:'2-digit', month:'short', day:'numeric'});

      const div = document.createElement('div');
      div.className = 'note';
      div.innerHTML = `<div class="pubkey">npub1${short}</div><div class="content">${escapeHtml(event.content)}</div><div class="time">${time}</div>`;
      feed.insertBefore(div, feed.firstChild);
    }

    function escapeHtml(s) {
      return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#039;'})[c]);
    }

    async function tryLogin() {
      if (!window.nostr) {
        alert('No Alby/NIP-07 extension detected.');
        return;
      }
      try {
        userPubkey = await window.nostr.getPublicKey();
        const short = userPubkey.slice(0,8) + '…' + userPubkey.slice(-8);
        document.getElementById('user-info').textContent = `Logged in as npub1${short}`;
        document.getElementById('header').textContent = `Friendzap - npub1${short}`;
        document.getElementById('login-screen').classList.add('hidden');
        document.getElementById('main-content').classList.remove('hidden');
        connectAndSubscribe();
      } catch (err) {
        alert('Connection failed: ' + err.message);
      }
    }

    function continueAnonymous() {
      document.getElementById('login-screen').classList.add('hidden');
      document.getElementById('main-content').classList.remove('hidden');
      document.getElementById('header').textContent = 'Friendzap (Anonymous)';
      connectAndSubscribe();
    }

    function logout() {
      userPubkey = null;
      followsCount = 0;
      document.getElementById('user-info').textContent = '';
      document.getElementById('follows-info').textContent = '';
      document.getElementById('header').textContent = 'Friendzap';
      document.getElementById('login-screen').classList.remove('hidden');
      document.getElementById('main-content').classList.add('hidden');
      if (ws) ws.close();
    }

    function showSection(id) {
      document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
      document.getElementById(id).classList.add('active');
      document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
      Array.from(document.querySelectorAll('.nav-item')).find(n => n.textContent === (id === 'home' ? 'Home' : 'Settings')).classList.add('active');
    }

    window.addEventListener('load', () => {
      loadSavedRelay();
      fetchBitcoinPrice();
      set200WMA();
      setInterval(fetchBitcoinPrice, 60000);
      document.getElementById('login-screen').classList.remove('hidden');
      document.getElementById('main-content').classList.add('hidden');
    });
  </script>
</head>
<body>

  <div id="login-screen">
    <h1>Friendzap</h1>
    <p>Connect with Alby or browse anonymously.</p>
    <button class="login-btn" onclick="tryLogin()">Connect with Alby</button>
    <button class="anon-btn" onclick="continueAnonymous()">Continue Anonymously</button>
    <p style="font-size:14px; color:#aaa;">Wait 10–60 seconds for notes. Relay URL saved automatically.</p>
  </div>

  <div id="main-content" class="hidden">
    <div id="header">Friendzap</div>
    <div class="container">
      <div class="pane left-pane">
        <div id="user-info"></div>
        <div id="follows-info"></div>
        <div class="nav-item active" onclick="showSection('home')">Home</div>
        <div class="nav-item" onclick="showSection('settings')">Settings</div>

        <div id="home" class="section active">
          <p style="color:#888;">Feed loading...</p>
          <button class="retry" onclick="connectAndSubscribe()">Retry / Refresh Feed</button>
        </div>

        <div id="settings" class="section">
          <h3>Network Settings</h3>
          <label>Relay URL (wss://...):</label>
          <input type="text" id="relay" value="wss://relay.damus.io" style="width:100%; padding:8px; margin:8px 0; background:#222; color:white; border:1px solid #444;"/>
          <button onclick="connectAndSubscribe()" style="padding:10px 20px; background:#0066cc; color:white; border:none; border-radius:4px; cursor:pointer; margin:10px 0;">Save & Refresh</button>
          <button onclick="logout()" style="padding:10px 20px; background:#cc0000; color:white; border:none; border-radius:4px; cursor:pointer;">Disconnect</button>
        </div>
      </div>

      <div class="pane center-pane" id="feed">
        <p style="color:#666; text-align:center; margin-top:100px;">Feed loading from relay...</p>
      </div>

      <div class="pane right-pane">
        <div style="background:#1e1e1e; padding:20px; margin-bottom:20px; border-radius:8px; text-align:center;">
          <h2>Bitcoin Price</h2>
          <div id="btc-price" style="font-size:32px; font-weight:bold; color:#f7931a;">Loading...</div>
        </div>
        <div style="background:#1e1e1e; padding:20px; border-radius:8px; text-align:center;">
          <h2>Bitcoin 200-Week MA</h2>
          <div id="btc-200wma" style="font-size:32px; font-weight:bold; color:#f7931a;">~$57849</div>
        </div>
      </div>
    </div>
  </div>

</body>
</html>
