<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Friendzap - Nostr Client</title>
  <!-- Browser bundle – reliable, no MIME/dependency issues -->
  <script src="https://unpkg.com/nostr-tools@2.21.0/lib/nostr.bundle.js"></script>
  <style>
    body { margin:0; font-family:sans-serif; background:#0f0f0f; color:#e0e0e0; height:100vh; overflow:hidden; }
    #header { background:#1a1a1a; padding:12px; text-align:center; font-size:28px; font-weight:bold; border-bottom:1px solid #333; }
    .container { display:flex; height:calc(100vh - 60px); }
    .pane { border-right:1px solid #333; overflow-y:auto; padding:20px; }
    .left-pane { width:280px; background:#111; }
    .center-pane { flex:1; background:#0a0a0a; }
    .right-pane { width:320px; background:#111; }
    .nav-item { padding:14px 20px; cursor:pointer; font-size:18px; border-bottom:1px solid #222; }
    .nav-item:hover, .nav-item.active { background:#222; }
    .section { display:none; }
    .section.active { display:block; }
    .note { background:#1e1e1e; padding:12px; margin:12px 0; border-radius:8px; border:1px solid #333; }
    .note .pubkey { color:#888; font-size:14px; margin-bottom:6px; }
    .note .content { white-space:pre-wrap; word-break:break-word; }
    .note .time { color:#666; font-size:12px; margin-top:8px; }
    #login-screen { position:fixed; inset:0; background:rgba(0,0,0,0.9); display:flex; flex-direction:column; align-items:center; justify-content:center; z-index:1000; text-align:center; padding:20px; }
    #login-screen.hidden { display:none; }
    #main-content.hidden { display:none; }
    .login-btn { padding:16px 32px; font-size:20px; background:#0066cc; border:none; color:white; border-radius:8px; cursor:pointer; margin:20px 0; }
    .login-btn:hover { background:#0055aa; }
    #user-info { font-size:16px; color:#4caf50; margin:10px 0; }
    button.retry { margin:20px auto; display:block; padding:12px 24px; background:#0066cc; color:white; border:none; border-radius:6px; cursor:pointer; }
  </style>
  <script>
    let relayPool = null;
    let sub = null;
    let userPubkey = null;

    async function fetchBitcoinPrice() {
      try {
        const res = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=usd');
        const data = await res.json();
        document.getElementById('btc-price').textContent = `$${data.bitcoin.usd.toLocaleString('en-US', {minimumFractionDigits: 0})}`;
      } catch (e) { console.error('Price fetch error:', e); }
    }

    function set200WMA() {
      document.getElementById('btc-200wma').textContent = '~$57849';
    }

    function getRelays() {
      const r1 = document.getElementById('relay1')?.value.trim() || 'wss://relay.damus.io';
      const r2 = document.getElementById('relay2')?.value.trim() || 'wss://nos.lol';
      return [r1, r2].filter(Boolean);
    }

    function connectAndSubscribe() {
      const relays = getRelays();
      console.log('Trying relays:', relays);

      if (relayPool) relayPool.close();
      if (sub) sub.unsub();

      if (!window.nostrTools || !window.nostrTools.RelayPool) {
        console.error('nostrTools bundle not loaded properly');
        document.getElementById('feed').innerHTML = '<p style="color:red; text-align:center;">Nostr library failed to load – check network/console for unpkg errors</p>';
        return;
      }

      try {
        relayPool = new window.nostrTools.RelayPool(relays);
      } catch (e) {
        console.error('RelayPool failed:', e);
        document.getElementById('feed').innerHTML = '<p style="color:red; text-align:center;">Error initializing: ' + e.message + '</p>';
        return;
      }

      relayPool.on('open', relay => {
        console.log('Connected to:', relay.url);
      });
      relayPool.on('error', (relay, err) => {
        console.error('Relay error:', relay?.url, err);
      });

      relayPool.connect();

      const since = Math.floor(Date.now() / 1000) - (86400 * 7);
      sub = relayPool.sub([{ kinds: [1], since }]);

      sub.on('event', event => {
        console.log('Event received:', event.id.slice(0,8));
        renderNote(event);
      });

      document.getElementById('feed').innerHTML = '<p style="color:#4caf50; text-align:center;">Connected – fetching notes...</p>';
    }

    function renderNote(event) {
      const feed = document.getElementById('feed');
      const short = event.pubkey.slice(0,8) + '…' + event.pubkey.slice(-8);
      const time = new Date(event.created_at * 1000).toLocaleString([], { hour: '2-digit', minute: '2-digit', month: 'short', day: 'numeric' });

      const div = document.createElement('div');
      div.className = 'note';
      div.innerHTML = `
        <div class="pubkey">npub1${short}</div>
        <div class="content">${escapeHtml(event.content)}</div>
        <div class="time">${time}</div>
      `;
      feed.insertBefore(div, feed.firstChild);
    }

    function escapeHtml(unsafe) {
      return unsafe.replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' })[m]);
    }

    async function tryLogin() {
      if (!window.nostr) {
        alert('No NIP-07 extension detected (Alby/Nos2x/etc.). Install one and reload.');
        return;
      }
      try {
        userPubkey = await window.nostr.getPublicKey();
        const short = userPubkey.slice(0,8) + '…' + userPubkey.slice(-8);
        document.getElementById('user-info').textContent = `Logged in as npub1${short}`;
        document.getElementById('header').textContent = `Friendzap - npub1${short}`;
        document.getElementById('login-screen').classList.add('hidden');
        document.getElementById('main-content').classList.remove('hidden');
        connectAndSubscribe();
      } catch (err) {
        alert('Login denied/failed: ' + err.message);
      }
    }

    function logout() {
      userPubkey = null;
      document.getElementById('user-info').textContent = '';
      document.getElementById('header').textContent = 'Friendzap';
      document.getElementById('login-screen').classList.remove('hidden');
      document.getElementById('main-content').classList.add('hidden');
      if (relayPool) relayPool.close();
    }

    window.addEventListener('load', () => {
      fetchBitcoinPrice();
      set200WMA();
      setInterval(fetchBitcoinPrice, 60000);
      document.getElementById('login-screen').classList.remove('hidden');
      document.getElementById('main-content').classList.add('hidden');
    });
  </script>
</head>
<body>

  <div id="login-screen">
    <h1>Friendzap</h1>
    <p>Connect with your Nostr extension (Alby is working for you!)</p>
    <button class="login-btn" onclick="tryLogin()">Connect with Nostr Extension</button>
    <p style="font-size:14px; color:#aaa;">Wait a few seconds if slow – unpkg bundle loads first.</p>
  </div>

  <div id="main-content" class="hidden">
    <div id="header">Friendzap</div>
    <div class="container">
      <div class="pane left-pane">
        <div id="user-info"></div>
        <div class="nav-item active" onclick="showSection('home')">Home</div>
        <div class="nav-item" onclick="showSection('settings')">Settings</div>

        <div id="home" class="section active">
          <p style="color:#888;">Feed loading from relays...</p>
          <button class="retry" onclick="connectAndSubscribe()">Retry / Refresh Feed</button>
        </div>

        <div id="settings" class="section">
          <h3>Network Settings</h3>
          <label>Relay 1:</label>
          <input type="text" id="relay1" value="wss://relay.damus.io" style="width:100%; padding:8px; margin:8px 0; background:#222; color:white; border:1px solid #444;"/>
          <label>Relay 2 (optional):</label>
          <input type="text" id="relay2" value="wss://nos.lol" style="width:100%; padding:8px; margin:8px 0; background:#222; color:white; border:1px solid #444;"/>
          <button onclick="connectAndSubscribe()" style="padding:10px 20px; background:#0066cc; color:white; border:none; border-radius:4px; cursor:pointer; margin:10px 0;">Save & Refresh</button>
          <button onclick="logout()" style="padding:10px 20px; background:#cc0000; color:white; border:none; border-radius:4px; cursor:pointer;">Disconnect</button>
        </div>
      </div>

      <div class="pane center-pane" id="feed">
        <p style="color:#666; text-align:center; margin-top:100px;">Feed will load after connection...</p>
      </div>

      <div class="pane right-pane">
        <div style="background:#1e1e1e; padding:20px; margin-bottom:20px; border-radius:8px; text-align:center;">
          <h2>Bitcoin Price</h2>
          <div id="btc-price" style="font-size:32px; font-weight:bold; color:#f7931a;">Loading...</div>
        </div>
        <div style="background:#1e1e1e; padding:20px; border-radius:8px; text-align:center;">
          <h2>Bitcoin 200-Week MA</h2>
          <div id="btc-200wma" style="font-size:32px; font-weight:bold; color:#f7931a;">~$57849</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    function showSection(id) {
      document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
      document.getElementById(id).classList.add('active');
      document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
      event.target.classList.add('active');
    }
  </script>

</body>
</html>
