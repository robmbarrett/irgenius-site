<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Nostr Key Generator - irgenius.org</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5n/N0RDwH4=" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

  <!-- nostr-tools -->
  <script src="https://unpkg.com/nostr-tools@2.11.0/lib/nostr.bundle.js"></script>

  <style>
    body { font-family: system-ui, sans-serif; max-width: 600px; margin: 40px auto; padding: 20px; text-align: center; background: #f9f9f9; color: #333; }
    h1, h2 { color: #2c3e50; margin-bottom: 20px; }
    button { color: white; border: none; padding: 14px 28px; font-size: 18px; margin: 10px; cursor: pointer; border-radius: 8px; }
    button.primary   { background: #27ae60; }
    button.primary:hover   { background: #219653; }
    button.primary:disabled { background: #95a5a6; cursor: not-allowed; }
    button.secondary { background: #3498db; }
    button.secondary:hover { background: #2980b9; }
    button.danger    { background: #e74c3c; }
    button.danger:hover    { background: #c0392b; }
    .result, #confirmation, #mapScreen { display: none; margin-top: 30px; background: white; padding: 25px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); text-align: left; }
    .warning { color: #e74c3c; font-weight: bold; margin-bottom: 15px; font-size: 1.1em; }
    pre { background: #ecf0f1; padding: 15px; border-radius: 6px; overflow-x: auto; font-family: monospace; white-space: pre-wrap; word-break: break-all; margin: 10px 0; }
    .actions { text-align: center; margin-top: 20px; }
    #status { color: #7f8c8d; font-size: 0.95em; margin-top: 10px; }

    /* Map container – force dimensions even when off-screen */
    #usMapContainer {
      width: 100%;
      height: 500px;
      min-height: 500px;
      border: 1px solid #ccc;
      border-radius: 8px;
      overflow: hidden;
      background: #e0f7fa;
    }

    /* Off-screen state for pre-creation */
    #usMapContainer.offscreen {
      position: absolute !important;
      left: -9999px !important;
      visibility: hidden !important;
      display: block !important;
    }
  </style>
</head>
<body>

<h1>Nostr Key Generator</h1>
<p>Generate a new Nostr key pair securely in your browser.<br><strong>Save your nsec</strong> — never share it!</p>

<button id="generateBtn" class="primary" onclick="generateKey()">Generate New Key</button>
<div id="status">Ready!</div>

<div id="result" class="result">
  <p class="warning">⚠️ BACKUP REQUIRED — SAVE THIS NOW!</p>
  <p><strong>Secret Key (nsec):</strong></p>
  <pre id="nsec"></pre>
  <p><strong>Public Key (npub):</strong></p>
  <pre id="npub"></pre>

  <div class="actions">
    <button onclick="downloadBackup()" class="primary">Download Backup (.txt)</button>
  </div>
</div>

<div id="confirmation" class="result">
  <h2>Backup Confirmation</h2>
  <p class="warning">Did you successfully download and save the <code>nostr-key-backup.txt</code> file?</p>
  <p><strong>Important:</strong> Without this backup you will permanently lose access to your account if you lose this device or clear browser data.</p>

  <div class="actions">
    <button id="confirmYes" class="primary">Yes, I saved it securely</button>
    <button id="confirmNo" class="danger">No, let me download again</button>
  </div>
</div>

<div id="mapScreen" class="result">
  <h2>Your Approximate Location</h2>
  <p>Blue dot = estimated location (browser geolocation preferred, falls back to IP)</p>
  <div id="usMapContainer" class="offscreen"></div>
</div>

<script>
let mapInstance = null;

function generateKey() {
  const btn = document.getElementById('generateBtn');
  const status = document.getElementById('status');
  btn.disabled = true;
  status.textContent = 'Generating secure key...';

  if (typeof NostrTools === 'undefined' || typeof NostrTools.generateSecretKey !== 'function') {
    status.textContent = 'Error: nostr-tools library failed to load.';
    console.error('NostrTools not available');
    btn.disabled = false;
    return;
  }

  try {
    const secretKey = NostrTools.generateSecretKey();
    const pubkey   = NostrTools.getPublicKey(secretKey);
    const nsec     = NostrTools.nip19.nsecEncode(secretKey);
    const npub     = NostrTools.nip19.npubEncode(pubkey);

    document.getElementById('nsec').textContent = nsec;
    document.getElementById('npub').textContent = npub;

    document.getElementById('result').style.display       = 'block';
    document.getElementById('confirmation').style.display = 'none';
    document.getElementById('mapScreen').style.display    = 'none';

    status.textContent = 'Key generated! Please create a backup.';
  } catch (err) {
    status.textContent = 'Error: ' + err.message;
    console.error('Key generation failed:', err);
  } finally {
    btn.disabled = false;
  }
}

function downloadBackup() {
  const nsec = document.getElementById('nsec').textContent;
  const npub = document.getElementById('npub').textContent;
  if (!nsec) return alert('No key generated yet.');

  const text = `Nostr Key Backup - ${new Date().toISOString()}
Secret Key (nsec): ${nsec}
Public Key (npub): ${npub}

⚠️ NEVER share your nsec! Store offline securely.`;

  const blob = new Blob([text], { type: 'text/plain' });
  const url  = URL.createObjectURL(blob);
  const a    = document.createElement('a');
  a.href     = url;
  a.download = 'nostr-key-backup.txt';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);

  document.getElementById('result').style.display = 'none';
  document.getElementById('confirmation').style.display = 'block';
  document.getElementById('status').textContent = 'Please confirm you saved the backup.';
}

document.getElementById('confirmYes').onclick = () => {
  document.getElementById('confirmation').style.display = 'none';
  const mapScreen = document.getElementById('mapScreen');
  const container = document.getElementById('usMapContainer');

  // Move container on-screen
  container.classList.remove('offscreen');
  mapScreen.style.display = 'block';

  // Force reflow
  mapScreen.offsetHeight;

  document.getElementById('status').textContent = 'Backup confirmed → showing location map.';
  loadUSMapWithLocation();
};

document.getElementById('confirmNo').onclick = () => {
  document.getElementById('confirmation').style.display = 'none';
  document.getElementById('result').style.display = 'block';
  document.getElementById('status').textContent = 'Back to key. Please download and save the file.';
};

function loadUSMapWithLocation() {
  const container = document.getElementById('usMapContainer');

  if (!mapInstance) {
    mapInstance = L.map('usMapContainer').setView([37.8, -96], 4);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
    }).addTo(mapInstance);

    // Aggressive initial redraw attempts
    setTimeout(() => mapInstance.invalidateSize(true), 100);
    setTimeout(() => mapInstance.invalidateSize(true), 300);
    setTimeout(() => mapInstance.invalidateSize(true), 600);
  }

  // ResizeObserver for any future size changes
  if ('ResizeObserver' in window) {
    const ro = new ResizeObserver(() => {
      if (mapInstance) mapInstance.invalidateSize();
    });
    ro.observe(container);
  }

  // Fallback polling (in case ResizeObserver not supported)
  const poll = setInterval(() => {
    if (container.clientHeight > 100 && container.clientWidth > 100) {
      if (mapInstance) mapInstance.invalidateSize(true);
      clearInterval(poll);
    }
  }, 200);

  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(
      pos => {
        const { latitude, longitude } = pos.coords;
        L.circleMarker([latitude, longitude], {
          radius: 12,
          color: '#3388ff',
          fillColor: '#3388ff',
          fillOpacity: 0.7,
          className: 'pulsing-dot'
        }).addTo(mapInstance).bindPopup('Your location (browser geolocation)');

        mapInstance.setView([latitude, longitude], 7);

        setTimeout(() => mapInstance.invalidateSize(true), 200);
        clearInterval(poll);
      },
      () => fallbackToIP(mapInstance),
      { timeout: 10000 }
    );
  } else {
    fallbackToIP(mapInstance);
  }
}

function fallbackToIP(map) {
  fetch('https://ipapi.co/json/')
    .then(res => res.json())
    .then(data => {
      if (data.latitude && data.longitude) {
        L.circleMarker([data.latitude, data.longitude], {
          radius: 12,
          color: '#3388ff',
          fillColor: '#3388ff',
          fillOpacity: 0.7,
          className: 'pulsing-dot'
        }).addTo(map).bindPopup(`Approx: ${data.city || 'Unknown'}, ${data.region || 'US'} (IP)`);

        map.setView([data.latitude, data.longitude], 6);
        setTimeout(() => map.invalidateSize(true), 200);
      } else {
        showNoLocation(map);
      }
    })
    .catch(() => showNoLocation(map));
}

function showNoLocation(map) {
  map.setView([39.8283, -98.5795], 4);
  setTimeout(() => map.invalidateSize(true), 200);
  alert('Could not determine your location.');
}
</script>
</body>
</html>
