<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Friendzap - Nostr Client</title>
  <script src="https://cdn.jsdelivr.net/npm/nostr-tools@2/lib/nostr.bundle.min.js"></script>
  <style>
    body { margin:0; font-family:sans-serif; background:#0f0f0f; color:#e0e0e0; height:100vh; overflow:hidden; }
    #header { background:#1a1a1a; padding:12px; text-align:center; font-size:28px; font-weight:bold; border-bottom:1px solid #333; }
    .container { display:flex; height:calc(100vh - 60px); }
    .pane { border-right:1px solid #333; overflow-y:auto; padding:20px; }
    .left-pane { width:280px; background:#111; }
    .center-pane { flex:1; background:#0a0a0a; }
    .right-pane { width:320px; background:#111; }
    .nav-item { padding:14px 20px; cursor:pointer; font-size:18px; border-bottom:1px solid #222; }
    .nav-item:hover, .nav-item.active { background:#222; }
    .section { display:none; }
    .section.active { display:block; }
    .note { background:#1e1e1e; padding:12px; margin:12px 0; border-radius:8px; border:1px solid #333; }
    .note .pubkey { color:#888; font-size:14px; margin-bottom:6px; }
    .note .content { white-space:pre-wrap; word-break:break-word; }
    .note .time { color:#666; font-size:12px; margin-top:8px; }
    #login-screen { position:fixed; inset:0; background:rgba(0,0,0,0.9); display:flex; flex-direction:column; align-items:center; justify-content:center; z-index:1000; text-align:center; padding:20px; }
    #login-screen.hidden { display:none; }
    #main-content.hidden { display:none; }
    .login-btn, .anon-btn { padding:12px 24px; font-size:18px; margin:10px; border:none; border-radius:6px; cursor:pointer; }
    .login-btn { background:#0066cc; color:white; }
    .anon-btn { background:#444; color:white; }
    #user-info { font-size:16px; color:#4caf50; margin:10px 0; }
    button.retry { margin:20px auto; display:block; padding:12px 24px; background:#0066cc; color:white; border:none; border-radius:6px; cursor:pointer; }
    input[type="text"], textarea { width:100%; padding:8px; margin:8px 0; background:#222; color:white; border:1px solid #444; }
    label { margin:8px 0; display:block; }
    .profile-field { margin:16px 0; font-size:16px; }
    .profile-field strong { display:inline-block; width:220px; color:#aaa; }
    small { color:#888; }
    #center-content { padding:20px; }
    #feed-content, #profile-content { display:none; }
    #feed-content.active, #profile-content.active { display:block; }
    .back-btn { padding:10px 16px; background:#444; color:white; border:none; border-radius:6px; cursor:pointer; margin-bottom:20px; }
  </style>
  <script>
    let ws = null;
    let userPubkey = null;
    let subscriptionId = null;       // notes
    let contactsSubId = null;
    let profileSubId = null;
    let followsCount = 0;
    let currentProfile = {};
    let currentTags = [];
    let currentView = 'feed'; // 'feed' or 'profile'

    async function fetchBitcoinPrice() {
      try {
        const res = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=usd');
        const data = await res.json();
        document.getElementById('btc-price').textContent = `$${data.bitcoin.usd.toLocaleString('en-US', {minimumFractionDigits: 0})}`;
      } catch {}
    }

    function set200WMA() { document.getElementById('btc-200wma').textContent = '~$57849'; }

    function loadSavedRelay() {
      const saved = localStorage.getItem('friendzap-relay');
      if (saved) document.getElementById('relay').value = saved;
    }

    function saveRelay() {
      const url = document.getElementById('relay').value.trim();
      if (url && url.startsWith('wss://')) localStorage.setItem('friendzap-relay', url);
    }

    function getRelayUrl() {
      let url = document.getElementById('relay').value.trim();
      if (!url || !url.startsWith('wss://')) url = 'wss://relay.damus.io';
      return url;
    }

    function connectAndSubscribe() {
      saveRelay();
      const url = getRelayUrl();
      if (ws) ws.close();
      ws = new WebSocket(url);

      ws.onopen = () => {
        document.getElementById('feed').innerHTML = '<p style="color:#4caf50; text-align:center;">Connected – requesting notes...</p>';

        subscriptionId = 'notes-' + Math.random().toString(36).substring(2,12);
        const since = Math.floor(Date.now() / 1000) - 86400 * 30;
        ws.send(JSON.stringify(["REQ", subscriptionId, {kinds:[1], since, limit:50}]));

        if (userPubkey) {
          contactsSubId = 'contacts-' + Math.random().toString(36).substring(2,12);
          ws.send(JSON.stringify(["REQ", contactsSubId, {kinds:[3], authors:[userPubkey], limit:1}]));

          // Persistent kind 0 sub
          profileSubId = 'profile-persist-' + Math.random().toString(36).substring(2,12);
          ws.send(JSON.stringify(["REQ", profileSubId, {kinds:[0], authors:[userPubkey], limit:5}])); // limit 5 to catch recent ones
        }
      };

      ws.onmessage = (msgEvent) => {
        const msg = JSON.parse(msgEvent.data);
        if (msg[0] === 'EVENT') {
          const event = msg[2];
          if (event.kind === 1) {
            renderNote(event);
          } else if (event.kind === 3 && event.pubkey === userPubkey) {
            const followed = event.tags.filter(t => t[0]==='p').map(t => t[1]);
            followsCount = followed.length;
            document.getElementById('follows-info').textContent = `You follow ${followsCount} people`;
          } else if (event.kind === 0 && event.pubkey === userPubkey) {
            try {
              currentProfile = JSON.parse(event.content || '{}');
              currentTags = event.tags || [];
              if (currentView === 'profile') renderProfile();
            } catch (e) { console.error('Bad profile JSON', e); }
          }
        } else if (msg[0] === 'EOSE') {
          if (msg[1] === subscriptionId && document.querySelectorAll('.note').length === 0) {
            document.getElementById('feed').innerHTML += '<p style="color:#ff9800; text-align:center;">No recent notes found</p>';
          }
          if (msg[1] === contactsSubId && followsCount === 0) {
            document.getElementById('follows-info').textContent = 'No follows found';
          }
        }
      };

      ws.onerror = () => {
        document.getElementById('feed').innerHTML = '<p style="color:red;">Connection error – check relay</p>';
      };
    }

    function renderNote(event) {
      const feed = document.getElementById('feed');
      const short = event.pubkey.slice(0,8)+'…'+event.pubkey.slice(-8);
      const time = new Date(event.created_at*1000).toLocaleString([],{hour:'2-digit',minute:'2-digit',month:'short',day:'numeric'});
      const div = document.createElement('div');
      div.className = 'note';
      div.innerHTML = `<div class="pubkey">npub1${short}</div><div class="content">${escapeHtml(event.content)}</div><div class="time">${time}</div>`;
      feed.insertBefore(div, feed.firstChild);
    }

    function escapeHtml(s) {
      return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#039;'})[c]);
    }

    async function tryLogin() {
      if (!window.nostr) { alert('No NIP-07 extension detected.'); return; }
      try {
        userPubkey = await window.nostr.getPublicKey();
        const short = userPubkey.slice(0,8)+'…'+userPubkey.slice(-8);
        document.getElementById('user-info').textContent = `Logged in as npub1${short}`;
        document.getElementById('header').textContent = `Friendzap - npub1${short}`;
        document.getElementById('login-screen').classList.add('hidden');
        document.getElementById('main-content').classList.remove('hidden');
        connectAndSubscribe();
      } catch (err) { alert('Login failed: ' + err.message); }
    }

    function continueAnonymous() {
      document.getElementById('login-screen').classList.add('hidden');
      document.getElementById('main-content').classList.remove('hidden');
      document.getElementById('header').textContent = 'Friendzap (Anonymous)';
      connectAndSubscribe();
    }

    function logout() {
      userPubkey = null; followsCount = 0; currentProfile = {}; currentTags = [];
      document.getElementById('user-info').textContent = '';
      document.getElementById('follows-info').textContent = '';
      document.getElementById('header').textContent = 'Friendzap';
      document.getElementById('login-screen').classList.remove('hidden');
      document.getElementById('main-content').classList.add('hidden');
      if (ws) ws.close();
    }

    function switchToFeed() {
      currentView = 'feed';
      document.getElementById('feed-content').classList.add('active');
      document.getElementById('profile-content').classList.remove('active');
      document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
      document.querySelector('.nav-item[onclick*="home"]').classList.add('active');
      document.getElementById('center-header').textContent = 'Feed';
    }

    function switchToProfile() {
      currentView = 'profile';
      document.getElementById('feed-content').classList.remove('active');
      document.getElementById('profile-content').classList.add('active');
      document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
      document.querySelector('.nav-item[onclick*="profile"]').classList.add('active');
      document.getElementById('center-header').textContent = 'Your Profile';
      if (userPubkey) fetchOwnProfile(); // force refresh
      renderProfile();
    }

    function fetchOwnProfile() {
      if (!ws || !userPubkey) return;
      const id = 'profile-pull-' + Date.now();
      ws.send(JSON.stringify(["REQ", id, {
        kinds: [0],
        authors: [userPubkey],
        limit: 3,          // get a few in case
        since: Math.floor(Date.now()/1000) - 86400*365  // last year
      }]));
      // Short timeout to show loading if nothing arrives
      setTimeout(() => {
        if (Object.keys(currentProfile).length === 0) {
          document.getElementById('view-name').textContent = '(not found on this relay)';
        }
      }, 5000);
    }

    function renderProfile() {
      document.getElementById('view-name').textContent = currentProfile.name || '(not set)';
      document.getElementById('view-display-name').textContent = currentProfile.display_name || currentProfile.name || '(not set)';
      document.getElementById('view-website').textContent = currentProfile.website || '(not set)';
      document.getElementById('view-about').textContent = currentProfile.about || '(not set)';
      document.getElementById('view-lud16').textContent = currentProfile.lud16 || '(not set)';
      document.getElementById('view-nip05').textContent = currentProfile.nip05 || '(not set)';

      const geohashTag = currentTags.find(t => t[0] === 'g');
      const isSharing = !!geohashTag;
      document.getElementById('view-location-status').textContent = isSharing
        ? `Sharing approximate location (geohash: ${geohashTag[1]})`
        : 'Not sharing location (private by default)';

      document.querySelector(`input[name="share-location"][value="${isSharing ? 'yes' : 'no'}"]`).checked = true;
    }

    async function saveLocation() {
      if (!userPubkey || !window.nostr) { alert('Must be logged in with NIP-07.'); return; }
      const share = document.querySelector('input[name="share-location"]:checked').value === 'yes';
      let newContent = { ...currentProfile };
      let newTags = currentTags.filter(t => t[0] !== 'g');

      if (share) {
        const geohash = '9q8y'; // placeholder — next: real geohash
        newContent.location = 'Approximate area shared';
        newTags.push(['g', geohash]);
      } else {
        delete newContent.location;
      }

      const event = {
        kind: 0,
        content: JSON.stringify(newContent),
        tags: newTags,
        created_at: Math.floor(Date.now() / 1000),
        pubkey: userPubkey
      };

      try {
        event.id = nostrTools.getEventHash(event);
        event.sig = await window.nostr.signEvent(event);
        ws.send(JSON.stringify(['EVENT', event]));
        alert('Published! It may take a moment to appear.');
        setTimeout(fetchOwnProfile, 2000); // re-pull after publish
      } catch (err) { alert('Publish failed: ' + err.message); }
    }

    window.addEventListener('load', () => {
      loadSavedRelay();
      fetchBitcoinPrice();
      set200WMA();
      setInterval(fetchBitcoinPrice, 60000);
      document.getElementById('login-screen').classList.remove('hidden');
    });
  </script>
</head>
<body>

  <div id="login-screen">
    <h1>Friendzap</h1>
    <p>Connect with Alby or browse anonymously.</p>
    <button class="login-btn" onclick="tryLogin()">Connect with Alby</button>
    <button class="anon-btn" onclick="continueAnonymous()">Continue Anonymously</button>
    <p style="font-size:14px; color:#aaa;">Wait 10–60 seconds for notes. Relay URL saved automatically.</p>
  </div>

  <div id="main-content" class="hidden">
    <div id="header">Friendzap</div>
    <div class="container">
      <div class="pane left-pane">
        <div id="user-info"></div>
        <div id="follows-info"></div>
        <div class="nav-item active" onclick="switchToFeed()">Home / Feed</div>
        <div class="nav-item" onclick="switchToProfile()">Profile</div>
        <div class="nav-item" onclick="document.getElementById('settings').classList.toggle('active');">Settings</div>

        <div id="settings" class="section" style="display:none; padding:20px;">
          <h3>Network Settings</h3>
          <label>Relay URL (wss://...):</label>
          <input type="text" id="relay" value="wss://relay.damus.io"/>
          <button onclick="connectAndSubscribe()" style="padding:10px 20px; background:#0066cc; color:white; border:none; border-radius:4px; cursor:pointer; margin:10px 0 0 0;">Save & Reconnect</button>
          <button onclick="logout()" style="padding:10px 20px; background:#cc0000; color:white; border:none; border-radius:4px; cursor:pointer; margin:10px 0 0 10px;">Disconnect</button>
        </div>
      </div>

      <div class="pane center-pane" id="center-content">
        <h2 id="center-header">Feed</h2>

        <div id="feed-content" class="active">
          <div id="feed"><p style="color:#666; text-align:center; margin-top:100px;">Feed loading from relay...</p></div>
          <button class="retry" onclick="connectAndSubscribe()">Retry / Refresh Feed</button>
        </div>

        <div id="profile-content">
          <button class="back-btn" onclick="switchToFeed()">← Back to Feed</button>
          <div class="profile-field"><strong>Username / Name:</strong> <span id="view-name">(loading...)</span></div>
          <div class="profile-field"><strong>Display Name:</strong> <span id="view-display-name">(loading...)</span></div>
          <div class="profile-field"><strong>Website:</strong> <span id="view-website">(loading...)</span></div>
          <div class="profile-field"><strong>About Me:</strong> <span id="view-about">(loading...)</span></div>
          <div class="profile-field"><strong>Bitcoin Lightning Address (lud16):</strong> <span id="view-lud16">(loading...)</span></div>
          <div class="profile-field"><strong>NIP-05 Verified:</strong> <span id="view-nip05">(loading...)</span></div>

          <h3>GeoLocation (Approximate Area)</h3>
          <p id="view-location-status">Loading...</p>

          <button onclick="document.getElementById('location-edit').style.display='block';">Edit Location</button>

          <div id="location-edit" style="display:none; margin-top:16px;">
            <label><input type="radio" name="share-location" value="no" checked> Do not share location</label>
            <label><input type="radio" name="share-location" value="yes"> Share approximate location</label>
            <p><small>Note: Enabling adds a coarse public geohash to your kind 0 profile. Use carefully — it's permanent on relays.</small></p>
            <button onclick="saveLocation()" style="padding:10px 20px; background:#0066cc; color:white; border:none; border-radius:4px; cursor:pointer; margin-top:12px;">Save Location Settings</button>
          </div>

          <p style="margin-top:40px;"><small>Full editing of name/about/etc. coming next. If fields stay "(not set)", try a different relay (many store profiles better).</small></p>
        </div>
      </div>

      <div class="pane right-pane">
        <div style="background:#1e1e1e; padding:20px; margin-bottom:20px; border-radius:8px; text-align:center;">
          <h2>Bitcoin Price</h2>
          <div id="btc-price" style="font-size:32px; font-weight:bold; color:#f7931a;">Loading...</div>
        </div>
        <div style="background:#1e1e1e; padding:20px; border-radius:8px; text-align:center;">
          <h2>Bitcoin 200-Week MA</h2>
          <div id="btc-200wma" style="font-size:32px; font-weight:bold; color:#f7931a;">~$57849</div>
        </div>
      </div>
    </div>
  </div>

</body>
</html>
